---
title: "Observations on the optimization process"
author: "Cristhian Paredes and Jesús Ágreda"
date: "`r Sys.Date()`"
output: 
  knitr:::html_vignette:
    toc: true
    fig_caption: yes
  pdf_document:
    highlight: null
    number_sections: yes
vignette: >
  %\VignetteIndexEntry{labsimplexModelSurface}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "48%"
)
# Render html vignetes by using devtools::document(roclets = "vignette")
# Render also pdf vignetes by using rmarkdown::render("vignettes/labsimplex.Rmd", "all")
require(labsimplex)
require(ggplot2)
```

```{r functions, echo = FALSE}
surfc <- function (x, y, noise = 0, seed = 0) {
  if (length(x) != length(y)) stop('Vector parameters x and y must have same length')
  # good range for Matlab's peaks function is -2, 2 for both x and y. We want 10, 90 for x and 1, 13 for y.
  x <- x * 0.05 - 16
  y <- y / 3 - 2.33
  set.seed(seed)
  return (4 * (10 + 10 * (1 - x)^2 * exp((- x^2 - (y + 1)^2)) -
                 10 * (x/5 - x^3 - y^5) * exp(- x^2 - y^2) -
                 1/3 * exp(- (x + 1)^2 - y^2)) + rnorm(n = length(x), mean = 0, sd = noise))
}
prspctv <- function (length, noise) {
  x <- seq(280, 360, length = length)
  y <- seq(1, 13, length = length)
  z <- outer(x, y, surfc, noise = noise)
  
  colors  <- colorRampPalette(c("grey10", "white"))(100)
  z.facet.center <- (z[-1, -1] + z[-1, -ncol(z)] + z[-nrow(z), -1] + z[-nrow(z), -ncol(z)])/4
  z.facet.range  <- cut(z.facet.center, 200)
  persp(x, y, z, theta = 130, phi = 20, ticktype = "detailed", col = colors[z.facet.range], lwd = 0.3,
        ltheta = -120, shade = 0.2, expand = 0.6, xlab = 'Temperature (K)', ylab = 'pH', zlab = 'Yield (%)')
}
cntr <- function (length, noise) {
  x <- seq(280, 360, length = length)
  y <- seq(1, 13, length = length)
  gg <- expand.grid(x = x, y = y)
  gg$z <- with(gg, surfc(x, y, noise = noise))
  
  brks <- cut(gg$z, breaks = seq(0, 100, len = 10))
  brks <- gsub(",", " - ", brks, fixed = TRUE)
  gg$brks <- gsub("\\(|\\]", "", brks)  # reformat guide labels
  p <- ggplot(gg, aes(x, y)) + 
    geom_tile(aes(fill = brks)) + scale_fill_manual("Z", values = colorRampPalette(c("grey20", "white"))(10)) +
    scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0)) +
    theme(legend.position = 'none', axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'), plot.margin = unit(c(0.5, 0.5, 0.1, 0.1), "cm")) + 
    labs(x = 'Temperature (K)', y = 'pH')
  return(p)
}
cntrOLD <- function (length, noise) {
  require(lattice)
    x <- seq(280, 360, length = length)
    y <- seq(1, 13, length = length)
    df <- data.frame(expand.grid(x, y), surfc(x = expand.grid(x, y)[, 1], y = expand.grid(x, y)[, 2], noise = noise))
    colnames(df) <- c('x', 'y', 'z')
    contourplot(z ~ x * y, df, lwd = 0.7, cuts = 10, labels = FALSE, region = TRUE,
                col.regions = colorRampPalette(c("grey10", "white")),
                xlab = 'Temperature (K)', ylab = 'pH', zlab = 'Yield (%)')
}
completeOptimization <- function (centroid, stepsize = c(0.6, 10), algor = 'fixed', experiments = 17,
                                  length = 300, noise = 0) {
  simplex <- labsimplex(N = 2, centroid = centroid, stepsize = stepsize, var.name = c('pH', 'Temperature'))
  for (ii in 1:experiments){
    if (ii == 1) {
      simplex <- generateVertex(simplex = simplex, algor = algor,
                                qflv = exmplsurface(temp = simplex$coords[, 2], pH = simplex$coords[, 1]))
    } else {
      simplex <- generateVertex(simplex = simplex, algor = algor,
                                qflv = exmplsurface(temp = simplex$coords[nrow(simplex$coords), 2], 
                                                     pH = simplex$coords[nrow(simplex$coords), 1]))
    }
  }
  p <- cntr(length = length, noise = noise) + geom_point(data = data.frame(x = simplex$coords[, 2], y = simplex$coords[, 1]))
  print(p)
}

```
## Introduction
This vignette ... ...

## Response surface studied
The response surface below is 

```{r plotsWOnoise, echo = FALSE}
  par(mar = c(1, 1, 0, 0))
  prspctv(length = 45, noise = 0)
  print(cntr(length = 350, noise = 0))
```

## Finding the *nearest* local optima
```{r LocalOptima, echo = FALSE, results = 'hide', message = FALSE}
completeOptimization(centroid = c(7.5, 290))
completeOptimization(centroid = c(4, 330))
completeOptimization(centroid = c(10.5, 290))
completeOptimization(centroid = c(8, 330))

completeOptimization(centroid = c(7.5, 290), algor = 'variable')
completeOptimization(centroid = c(4, 330), algor = 'variable')
completeOptimization(centroid = c(10.5, 290), algor = 'variable')
completeOptimization(centroid = c(8, 330), algor = 'variable')

```

## Noisy response surface
```{r plotsW2noise, echo = FALSE}
  par(mar = c(1, 1, 0.1, 0.1))
  plot1 <- prspctv(length = 45, noise = 2)
  plot2 <- cntr(length = 45, noise = 2)
  print(plot2)
```
```{r plotsW4noise, echo = FALSE}
  par(mar = c(1, 1, 0.1, 0.1))
  plot1 <- prspctv(length = 45, noise = 7)
  plot2 <- cntr(length = 45, noise = 7)
  plot2 <- cntr(length = 45, noise = 7)
  print(plot2)
```
```{r plotsW7noise, echo = FALSE}
  par(mar = c(1, 1, 0.1, 0.1))
  plot1 <- prspctv(length = 45, noise = 10)
  plot2 <- cntr(length = 45, noise = 10)
  print(plot2)
```
  
